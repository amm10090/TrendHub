# FMTC çˆ¬è™«ç³»ç»Ÿå®ç°æ€»ç»“ ğŸ“‹

æœ¬æ–‡æ¡£æä¾› TrendHub FMTC çˆ¬è™«ç³»ç»Ÿçš„å®Œæ•´å®ç°æ€»ç»“ï¼ŒåŒ…æ‹¬æŠ€æœ¯å†³ç­–ã€æ¶æ„ç‰¹ç‚¹ã€åŠŸèƒ½ç‰¹æ€§ã€æ€§èƒ½æŒ‡æ ‡å’Œå¼€å‘å†ç¨‹ã€‚

## ğŸ“– é¡¹ç›®æ¦‚è¿°

### ğŸ¯ é¡¹ç›®èƒŒæ™¯

FMTC (FindMyCashback.com) æ˜¯ä¸€ä¸ªé¢†å…ˆçš„ä»£ç†ç½‘ç»œå¹³å°ï¼Œæ‹¥æœ‰æ•°åƒä¸ªå•†æˆ·åˆä½œä¼™ä¼´ã€‚ä¸ºäº†æ”¯æŒ TrendHub å¹³å°çš„å•†æˆ·æ•°æ®ç®¡ç†éœ€æ±‚ï¼Œæˆ‘ä»¬å¼€å‘äº†ä¸€å¥—å®Œæ•´çš„ FMTC æ•°æ®æŠ“å–ç³»ç»Ÿï¼Œèƒ½å¤Ÿè‡ªåŠ¨åŒ–æ”¶é›†ã€éªŒè¯å’Œç®¡ç†å•†æˆ·ä¿¡æ¯ã€‚

### ğŸš€ æ ¸å¿ƒç›®æ ‡

- **è‡ªåŠ¨åŒ–æ•°æ®é‡‡é›†**: å‡å°‘æ‰‹åŠ¨æ•°æ®æ”¶é›†å·¥ä½œé‡
- **å®æ—¶æ•°æ®æ›´æ–°**: ä¿æŒå•†æˆ·ä¿¡æ¯çš„åŠæ—¶æ€§å’Œå‡†ç¡®æ€§
- **å¤§è§„æ¨¡å¤„ç†èƒ½åŠ›**: æ”¯æŒæ•°åƒå•†æˆ·çš„æ‰¹é‡æ•°æ®å¤„ç†
- **æ™ºèƒ½æ•°æ®éªŒè¯**: ç¡®ä¿æ•°æ®è´¨é‡å’Œä¸€è‡´æ€§
- **ç”¨æˆ·å‹å¥½ç•Œé¢**: æä¾›ç›´è§‚çš„ç®¡ç†å’Œç›‘æ§ç•Œé¢

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„æ€»è§ˆ

### ğŸ“Š æ•´ä½“æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    TrendHub FMTC çˆ¬è™«ç³»ç»Ÿ                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  å‰ç«¯ç®¡ç†ç•Œé¢ (React + Next.js)                              â”‚
â”‚  â”œâ”€â”€ å•†æˆ·ç®¡ç†é¡µé¢                                            â”‚
â”‚  â”œâ”€â”€ æ‰¹é‡æ“ä½œç•Œé¢                                            â”‚
â”‚  â”œâ”€â”€ å®æ—¶è¿›åº¦ç›‘æ§                                            â”‚
â”‚  â””â”€â”€ æ•°æ®å¯¼å‡ºå·¥å…·                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åç«¯ API (Next.js App Router)                              â”‚
â”‚  â”œâ”€â”€ RESTful API ç«¯ç‚¹                                       â”‚
â”‚  â”œâ”€â”€ Server Actions                                         â”‚
â”‚  â”œâ”€â”€ Server-Sent Events                                     â”‚
â”‚  â””â”€â”€ æ•°æ®éªŒè¯å±‚                                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  çˆ¬è™«æ ¸å¿ƒå¼•æ“ (@repo/scraper)                                â”‚
â”‚  â”œâ”€â”€ å•å•†æˆ·çˆ¬è™« (FMTCSingleMerchantScraper)                  â”‚
â”‚  â”œâ”€â”€ æ‰¹é‡çˆ¬è™« (FMTCBatchMerchantScraper)                     â”‚
â”‚  â”œâ”€â”€ ç™»å½•å¤„ç†å™¨ (FMTCLoginHandler)                           â”‚
â”‚  â”œâ”€â”€ æœç´¢å¤„ç†å™¨ (FMTCSearchHandler)                          â”‚
â”‚  â”œâ”€â”€ ç»“æœè§£æå™¨ (FMTCResultsParser)                          â”‚
â”‚  â””â”€â”€ ä¼šè¯ç®¡ç†å™¨ (FMTCSessionManager)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  åŸºç¡€è®¾æ–½å±‚                                                   â”‚
â”‚  â”œâ”€â”€ Playwright æµè§ˆå™¨è‡ªåŠ¨åŒ–                                 â”‚
â”‚  â”œâ”€â”€ PostgreSQL æ•°æ®å­˜å‚¨                                     â”‚
â”‚  â”œâ”€â”€ Redis ç¼“å­˜ (å¯é€‰)                                       â”‚
â”‚  â””â”€â”€ æ–‡ä»¶ç³»ç»Ÿå­˜å‚¨                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ”§ æŠ€æœ¯æ ˆè¯¦æƒ…

#### å‰ç«¯æŠ€æœ¯æ ˆ

- **React 18+**: ç°ä»£åŒ–ç»„ä»¶å¼€å‘
- **Next.js 15.3+**: å…¨æ ˆæ¡†æ¶ï¼Œæ”¯æŒ App Router
- **TypeScript**: ç±»å‹å®‰å…¨çš„å¼€å‘ä½“éªŒ
- **Tailwind CSS**: å®ç”¨ä¼˜å…ˆçš„æ ·å¼æ¡†æ¶
- **HeroUI**: ç°ä»£åŒ– UI ç»„ä»¶åº“
- **React Hook Form**: é«˜æ€§èƒ½è¡¨å•å¤„ç†
- **SWR**: æ•°æ®è·å–å’Œç¼“å­˜

#### åç«¯æŠ€æœ¯æ ˆ

- **Next.js App Router**: ç°ä»£åŒ–è·¯ç”±å’Œ API å¤„ç†
- **Server Actions**: æœåŠ¡å™¨ç«¯æ“ä½œ
- **Prisma ORM**: ç±»å‹å®‰å…¨çš„æ•°æ®åº“æ“ä½œ
- **PostgreSQL**: å¯é çš„å…³ç³»å‹æ•°æ®åº“
- **Zod**: è¿è¡Œæ—¶æ•°æ®éªŒè¯

#### çˆ¬è™«æŠ€æœ¯æ ˆ

- **Playwright**: ç°ä»£åŒ–æµè§ˆå™¨è‡ªåŠ¨åŒ–
- **TypeScript**: å…¨æ ˆç±»å‹å®‰å…¨
- **Node.js 18+**: é«˜æ€§èƒ½è¿è¡Œæ—¶
- **EventEmitter**: äº‹ä»¶é©±åŠ¨æ¶æ„

## ğŸ¨ æ ¸å¿ƒåŠŸèƒ½å®ç°

### ğŸ” 1. æ™ºèƒ½ç™»å½•ç³»ç»Ÿ

#### ç‰¹æ€§æ¦‚è§ˆ

- **è‡ªåŠ¨åŒ–ç™»å½•**: æ”¯æŒç”¨æˆ·åå¯†ç è‡ªåŠ¨å¡«å†™
- **ä¼šè¯æŒä¹…åŒ–**: è‡ªåŠ¨ä¿å­˜å’Œæ¢å¤ç™»å½•çŠ¶æ€
- **reCAPTCHA å¤„ç†**: æ”¯æŒæ‰‹åŠ¨å’Œè‡ªåŠ¨éªŒè¯æ¨¡å¼
- **åæ£€æµ‹æœºåˆ¶**: æµè§ˆå™¨æŒ‡çº¹ä¼ªè£…å’Œè¡Œä¸ºæ¨¡æ‹Ÿ

#### å®ç°ç»†èŠ‚

```typescript
// æ ¸å¿ƒç™»å½•é€»è¾‘
export class FMTCLoginHandler {
  // ä¸»ç™»å½•æ–¹æ³•
  async login(credentials: LoginCredentials): Promise<LoginResult> {
    try {
      // 1. å¯¼èˆªåˆ°ç™»å½•é¡µé¢
      await this.navigateToLoginPage();

      // 2. å¡«å†™ç™»å½•å‡­æ®
      await this.fillCredentials(credentials);

      // 3. å¤„ç† reCAPTCHA (å¦‚æœå­˜åœ¨)
      await this.handleRecaptcha();

      // 4. æäº¤ç™»å½•è¡¨å•
      await this.submitLoginForm();

      // 5. éªŒè¯ç™»å½•æˆåŠŸ
      const success = await this.verifyLoginSuccess();

      // 6. ä¿å­˜ä¼šè¯çŠ¶æ€
      if (success) {
        await this.saveSession();
      }

      return { success, sessionData: this.sessionData };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  // reCAPTCHA å¤„ç†
  private async handleRecaptcha(): Promise<void> {
    const mode = process.env.FMTC_RECAPTCHA_MODE || "manual";

    switch (mode) {
      case "manual":
        await this.handleManualRecaptcha();
        break;
      case "auto":
        await this.handleAutoRecaptcha();
        break;
      case "skip":
        // è·³è¿‡éªŒè¯ï¼Œä»…ç”¨äºæµ‹è¯•
        break;
    }
  }
}
```

#### åæ£€æµ‹æœºåˆ¶

```typescript
// æµè§ˆå™¨æŒ‡çº¹ä¼ªè£…
const antiDetectionConfig = {
  // ç”¨æˆ·ä»£ç†ä¼ªè£…
  userAgent: "Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36",

  // è§†å£å°ºå¯¸éšæœºåŒ–
  viewport: { width: 1366 + Math.floor(Math.random() * 200), height: 768 },

  // ç¦ç”¨è‡ªåŠ¨åŒ–æ£€æµ‹
  args: [
    "--disable-blink-features=AutomationControlled",
    "--disable-web-security",
    "--disable-features=VizDisplayCompositor",
  ],

  // JavaScript æ‰§è¡Œ
  evaluateOnNewDocument: () => {
    // åˆ é™¤ webdriver å±æ€§
    delete navigator.__proto__.webdriver;

    // ä¼ªè£… Chrome è¿è¡Œæ—¶
    window.chrome = { runtime: {} };
  },
};
```

### ğŸ” 2. é«˜çº§æœç´¢ç³»ç»Ÿ

#### æœç´¢å‚æ•°æ”¯æŒ

- **æ–‡æœ¬æœç´¢**: å•†æˆ·åç§°ã€FMTC IDã€å…³é”®è¯
- **åˆ†ç±»ç­›é€‰**: æŒ‰å•†æˆ·ç±»åˆ«ç­›é€‰
- **åœ°ç†ç­›é€‰**: å›½å®¶å’Œé…é€åœ°åŒº
- **çŠ¶æ€ç­›é€‰**: æ¥å—ç”³è¯·/ä¸æ¥å—ç”³è¯·
- **ç½‘ç»œç­›é€‰**: ç‰¹å®šä»£ç†ç½‘ç»œ

#### äººç±»è¡Œä¸ºæ¨¡æ‹Ÿ

```typescript
export class FMTCSearchHandler {
  // æ‰§è¡Œæœç´¢
  async performSearch(params: SearchParams): Promise<SearchResult> {
    try {
      // 1. å¯¼èˆªåˆ°æœç´¢é¡µé¢
      await this.navigateToSearchPage();

      // 2. æ¨¡æ‹Ÿäººç±»è¾“å…¥è¡Œä¸º
      await this.simulateHumanTyping(params.searchText);

      // 3. è®¾ç½®ç­›é€‰æ¡ä»¶
      await this.applyFilters(params);

      // 4. æäº¤æœç´¢
      await this.submitSearch();

      // 5. ç­‰å¾…ç»“æœåŠ è½½
      await this.waitForResults();

      return { success: true, resultsCount: await this.getResultsCount() };
    } catch (error) {
      return { success: false, error: error.message };
    }
  }

  // äººç±»è¡Œä¸ºè¾“å…¥æ¨¡æ‹Ÿ
  private async simulateHumanTyping(text: string): Promise<void> {
    const searchInput = await this.page.locator("#search-input");

    // æ¸…ç©ºè¾“å…¥æ¡†
    await searchInput.clear();

    // æ¨¡æ‹Ÿé€å­—ç¬¦è¾“å…¥
    for (const char of text) {
      await searchInput.type(char);

      // éšæœºè¾“å…¥å»¶è¿Ÿ
      const delay = Math.random() * (200 - 50) + 50;
      await this.page.waitForTimeout(delay);
    }

    // æ¨¡æ‹Ÿé¼ æ ‡ç§»åŠ¨
    if (this.config.enableMouseMovement) {
      await this.simulateMouseMovement();
    }
  }
}
```

### ğŸ“Š 3. æ•°æ®è§£æå’Œå¯¼å‡º

#### å•†æˆ·æ•°æ®ç»“æ„

```typescript
interface MerchantInfo {
  // åŸºç¡€ä¿¡æ¯
  id?: string; // å•†æˆ·å”¯ä¸€æ ‡è¯†
  name: string; // å•†æˆ·åç§°
  url?: string; // å•†æˆ·å®˜ç½‘
  description?: string; // å•†æˆ·æè¿°

  // ä¸šåŠ¡ä¿¡æ¯
  category?: string; // å•†æˆ·åˆ†ç±»
  country?: string; // æ‰€åœ¨å›½å®¶
  network?: string; // å…³è”ç½‘ç»œ

  // ä½£é‡‘ä¿¡æ¯
  commissionRate?: string; // ä½£é‡‘ç‡
  cookieDuration?: string; // Cookie æœ‰æ•ˆæœŸ
  ecdDuration?: string; // ECD æŒç»­æ—¶é—´

  // çŠ¶æ€ä¿¡æ¯
  status?: "accepting" | "not_accepting" | "unknown";
  joinUrl?: string; // ç”³è¯·åŠ å…¥é“¾æ¥

  // å…ƒæ•°æ®
  logoUrl?: string; // å•†æˆ· Logo
  lastUpdated?: Date; // æœ€åæ›´æ–°æ—¶é—´

  // è‡ªå®šä¹‰å­—æ®µ
  tags?: string[]; // æ ‡ç­¾
  notes?: string; // å¤‡æ³¨
}
```

#### æ•°æ®éªŒè¯ç³»ç»Ÿ

```typescript
export class DataValidator {
  // éªŒè¯å•†æˆ·æ•°æ®
  static validateMerchantData(merchant: MerchantInfo): ValidationResult {
    const errors: string[] = [];
    const warnings: string[] = [];

    // å¿…å¡«å­—æ®µéªŒè¯
    if (!merchant.name || merchant.name.trim().length === 0) {
      errors.push("å•†æˆ·åç§°ä¸èƒ½ä¸ºç©º");
    }

    // URL æ ¼å¼éªŒè¯
    if (merchant.url && !this.isValidUrl(merchant.url)) {
      warnings.push("å•†æˆ·URLæ ¼å¼å¯èƒ½ä¸æ­£ç¡®");
    }

    // ä½£é‡‘ç‡æ ¼å¼éªŒè¯
    if (
      merchant.commissionRate &&
      !this.isValidCommissionRate(merchant.commissionRate)
    ) {
      warnings.push("ä½£é‡‘ç‡æ ¼å¼å¯èƒ½ä¸æ­£ç¡®");
    }

    return {
      isValid: errors.length === 0,
      errors,
      warnings,
    };
  }

  // URL éªŒè¯
  private static isValidUrl(url: string): boolean {
    try {
      new URL(url);
      return true;
    } catch {
      return false;
    }
  }

  // ä½£é‡‘ç‡éªŒè¯
  private static isValidCommissionRate(rate: string): boolean {
    return /^\d+(\.\d+)?%?$/.test(rate.trim());
  }
}
```

### ğŸš€ 4. æ‰¹é‡å¤„ç†ç³»ç»Ÿ

#### æ‰¹é‡æŠ“å–æ¶æ„

```typescript
export class FMTCBatchMerchantScraper extends EventEmitter {
  private workers: BrowserWorker[] = [];
  private taskQueue: SearchTask[] = [];
  private results: BatchResult[] = [];

  // æ‰¹é‡æŠ“å–ä¸»æ–¹æ³•
  async scrapeMultiple(tasks: SearchParams[]): Promise<BatchResult> {
    try {
      // 1. åˆå§‹åŒ–å·¥ä½œçº¿ç¨‹æ± 
      await this.initializeWorkerPool();

      // 2. åˆ†å‘ä»»åŠ¡åˆ°é˜Ÿåˆ—
      this.distributeTasksToQueue(tasks);

      // 3. æ‰§è¡Œå¹¶è¡Œå¤„ç†
      const results = await this.processTasksInParallel();

      // 4. åˆå¹¶å’ŒéªŒè¯ç»“æœ
      const finalResult = await this.mergeAndValidateResults(results);

      return finalResult;
    } catch (error) {
      this.emit("error", error);
      throw error;
    } finally {
      await this.cleanup();
    }
  }

  // å·¥ä½œçº¿ç¨‹æ± åˆå§‹åŒ–
  private async initializeWorkerPool(): Promise<void> {
    const concurrency = this.config.maxConcurrency || 3;

    for (let i = 0; i < concurrency; i++) {
      const worker = new BrowserWorker(`worker-${i}`, this.config);
      await worker.initialize();
      this.workers.push(worker);
    }

    this.logger.info(`å·²åˆå§‹åŒ– ${concurrency} ä¸ªå·¥ä½œçº¿ç¨‹`);
  }

  // å¹¶è¡Œä»»åŠ¡å¤„ç†
  private async processTasksInParallel(): Promise<BatchResult[]> {
    const promises = this.workers.map((worker) =>
      this.processWorkerTasks(worker),
    );

    // ç›‘å¬è¿›åº¦æ›´æ–°
    this.startProgressMonitoring();

    return Promise.all(promises);
  }

  // å•ä¸ªå·¥ä½œçº¿ç¨‹ä»»åŠ¡å¤„ç†
  private async processWorkerTasks(
    worker: BrowserWorker,
  ): Promise<BatchResult> {
    const workerResults: MerchantInfo[] = [];
    let tasksCompleted = 0;

    while (this.taskQueue.length > 0) {
      const task = this.taskQueue.shift();
      if (!task) break;

      try {
        this.logger.info(`Worker ${worker.id} å¤„ç†ä»»åŠ¡: ${task.searchText}`);

        // æ‰§è¡Œå•ä¸ªä»»åŠ¡
        const result = await worker.executeTask(task);
        workerResults.push(...result.merchants);

        tasksCompleted++;

        // å‘é€è¿›åº¦æ›´æ–°
        this.emit("progress", {
          workerId: worker.id,
          tasksCompleted,
          totalTasks: this.taskQueue.length + tasksCompleted,
          currentTask: task.searchText,
        });

        // ä»»åŠ¡é—´éš”
        await this.delay(this.config.taskInterval || 2000);
      } catch (error) {
        this.logger.error(`Worker ${worker.id} ä»»åŠ¡å¤±è´¥:`, error);
        this.emit("error", { workerId: worker.id, task, error });
      }
    }

    return {
      workerId: worker.id,
      merchants: workerResults,
      tasksCompleted,
    };
  }
}
```

### ğŸ“¡ 5. å®æ—¶è¿›åº¦ç›‘æ§

#### Server-Sent Events å®ç°

```typescript
// åç«¯ SSE ç«¯ç‚¹
export async function GET(request: NextRequest) {
  const encoder = new TextEncoder();

  const stream = new ReadableStream({
    start(controller) {
      // è®¾ç½® SSE è¿æ¥
      const headers = {
        "Content-Type": "text/event-stream",
        "Cache-Control": "no-cache",
        Connection: "keep-alive",
      };

      // ç›‘å¬çˆ¬è™«è¿›åº¦äº‹ä»¶
      scraperEventEmitter.on("progress", (data) => {
        const sseData = `data: ${JSON.stringify(data)}\n\n`;
        controller.enqueue(encoder.encode(sseData));
      });

      // ç›‘å¬é”™è¯¯äº‹ä»¶
      scraperEventEmitter.on("error", (error) => {
        const errorData = `data: ${JSON.stringify({
          type: "error",
          message: error.message,
        })}\n\n`;
        controller.enqueue(encoder.encode(errorData));
      });

      // å‘é€åˆå§‹è¿æ¥ç¡®è®¤
      const initData = `data: ${JSON.stringify({
        type: "connected",
        timestamp: new Date().toISOString(),
      })}\n\n`;
      controller.enqueue(encoder.encode(initData));
    },

    cancel() {
      // æ¸…ç†ç›‘å¬å™¨
      scraperEventEmitter.removeAllListeners("progress");
      scraperEventEmitter.removeAllListeners("error");
    },
  });

  return new Response(stream, { headers });
}
```

#### å‰ç«¯è¿›åº¦ç›‘æ§ç»„ä»¶

```tsx
// React ç»„ä»¶ - å®æ—¶è¿›åº¦ç›‘æ§
export function ScrapingProgressMonitor({ taskId }: { taskId: string }) {
  const [progress, setProgress] = useState<ProgressData | null>(null);
  const [status, setStatus] = useState<
    "idle" | "running" | "completed" | "error"
  >("idle");

  useEffect(() => {
    // å»ºç«‹ SSE è¿æ¥
    const eventSource = new EventSource(
      `/api/scraping/progress?taskId=${taskId}`,
    );

    eventSource.onmessage = (event) => {
      const data = JSON.parse(event.data);

      switch (data.type) {
        case "connected":
          setStatus("running");
          break;

        case "progress":
          setProgress(data);
          break;

        case "completed":
          setStatus("completed");
          setProgress(data);
          eventSource.close();
          break;

        case "error":
          setStatus("error");
          console.error("æŠ“å–é”™è¯¯:", data.message);
          eventSource.close();
          break;
      }
    };

    eventSource.onerror = () => {
      setStatus("error");
      eventSource.close();
    };

    return () => {
      eventSource.close();
    };
  }, [taskId]);

  return (
    <div className="bg-white rounded-lg shadow p-6">
      <h3 className="text-lg font-semibold mb-4">æŠ“å–è¿›åº¦</h3>

      {/* çŠ¶æ€æŒ‡ç¤ºå™¨ */}
      <div className="flex items-center mb-4">
        <StatusIndicator status={status} />
        <span className="ml-2 text-sm text-gray-600">
          {status === "running"
            ? "æŠ“å–ä¸­..."
            : status === "completed"
              ? "å·²å®Œæˆ"
              : status === "error"
                ? "å‡ºç°é”™è¯¯"
                : "ç­‰å¾…å¼€å§‹"}
        </span>
      </div>

      {/* è¿›åº¦æ¡ */}
      {progress && (
        <div className="space-y-4">
          <div className="w-full bg-gray-200 rounded-full h-2">
            <div
              className="bg-blue-600 h-2 rounded-full transition-all duration-300"
              style={{ width: `${progress.percentage}%` }}
            />
          </div>

          <div className="grid grid-cols-2 gap-4 text-sm">
            <div>å·²å®Œæˆ: {progress.completed}</div>
            <div>æ€»è®¡: {progress.total}</div>
            <div>æˆåŠŸ: {progress.successful}</div>
            <div>å¤±è´¥: {progress.failed}</div>
          </div>

          {progress.currentTask && (
            <div className="text-sm text-gray-600">
              å½“å‰ä»»åŠ¡: {progress.currentTask}
            </div>
          )}

          {progress.estimatedTimeRemaining && (
            <div className="text-sm text-gray-600">
              é¢„è®¡å‰©ä½™æ—¶é—´: {formatDuration(progress.estimatedTimeRemaining)}
            </div>
          )}
        </div>
      )}
    </div>
  );
}
```

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### ğŸš€ 1. å¹¶å‘æ§åˆ¶ä¼˜åŒ–

#### è‡ªé€‚åº”å¹¶å‘ç­–ç•¥

```typescript
export class AdaptiveConcurrencyController {
  private currentConcurrency: number = 1;
  private maxConcurrency: number = 5;
  private minConcurrency: number = 1;
  private successRate: number = 1.0;
  private responseTimeHistory: number[] = [];

  // åŠ¨æ€è°ƒæ•´å¹¶å‘æ•°
  adjustConcurrency(metrics: PerformanceMetrics): void {
    const { successRate, avgResponseTime, errorRate } = metrics;

    // åŸºäºæˆåŠŸç‡è°ƒæ•´
    if (successRate > 0.95 && avgResponseTime < 3000) {
      // æ€§èƒ½è‰¯å¥½ï¼Œå¯ä»¥å¢åŠ å¹¶å‘
      this.increaseConcurrency();
    } else if (successRate < 0.85 || avgResponseTime > 8000) {
      // æ€§èƒ½ä¸‹é™ï¼Œå‡å°‘å¹¶å‘
      this.decreaseConcurrency();
    }

    // åŸºäºé”™è¯¯ç‡è°ƒæ•´
    if (errorRate > 0.1) {
      this.decreaseConcurrency();
    }

    this.logger.info(`å¹¶å‘æ•°è°ƒæ•´ä¸º: ${this.currentConcurrency}`);
  }

  private increaseConcurrency(): void {
    if (this.currentConcurrency < this.maxConcurrency) {
      this.currentConcurrency = Math.min(
        this.currentConcurrency + 1,
        this.maxConcurrency,
      );
    }
  }

  private decreaseConcurrency(): void {
    if (this.currentConcurrency > this.minConcurrency) {
      this.currentConcurrency = Math.max(
        this.currentConcurrency - 1,
        this.minConcurrency,
      );
    }
  }
}
```

### ğŸ’¾ 2. å†…å­˜ç®¡ç†ä¼˜åŒ–

#### å†…å­˜ç›‘æ§å’Œåƒåœ¾å›æ”¶

```typescript
export class MemoryManager {
  private memoryThreshold: number = 500; // MB
  private gcInterval: number = 60000; // 60ç§’

  constructor() {
    this.startMemoryMonitoring();
  }

  // å¯åŠ¨å†…å­˜ç›‘æ§
  private startMemoryMonitoring(): void {
    setInterval(() => {
      const usage = process.memoryUsage();
      const usedMB = usage.heapUsed / 1024 / 1024;

      this.logger.debug(`å†…å­˜ä½¿ç”¨: ${usedMB.toFixed(2)} MB`);

      // å†…å­˜ä½¿ç”¨è¶…è¿‡é˜ˆå€¼æ—¶è§¦å‘åƒåœ¾å›æ”¶
      if (usedMB > this.memoryThreshold) {
        this.forceGarbageCollection();
      }
    }, this.gcInterval);
  }

  // å¼ºåˆ¶åƒåœ¾å›æ”¶
  private forceGarbageCollection(): void {
    if (global.gc) {
      global.gc();
      this.logger.info("å·²æ‰§è¡Œåƒåœ¾å›æ”¶");

      const usage = process.memoryUsage();
      const usedMB = usage.heapUsed / 1024 / 1024;
      this.logger.info(`åƒåœ¾å›æ”¶åå†…å­˜ä½¿ç”¨: ${usedMB.toFixed(2)} MB`);
    }
  }

  // æ¸…ç†é¡µé¢èµ„æº
  async cleanupPageResources(page: Page): Promise<void> {
    try {
      // æ¸…ç†ç¼“å­˜
      await page.context().clearCookies();

      // æ¸…ç†æœ¬åœ°å­˜å‚¨
      await page.evaluate(() => {
        localStorage.clear();
        sessionStorage.clear();
      });

      // åœæ­¢æ‰€æœ‰ç½‘ç»œè¯·æ±‚
      await page.route("**/*", (route) => route.abort());
    } catch (error) {
      this.logger.warn("é¡µé¢èµ„æºæ¸…ç†å¤±è´¥:", error);
    }
  }
}
```

### ğŸ”„ 3. ç¼“å­˜ç­–ç•¥

#### å¤šå±‚ç¼“å­˜ç³»ç»Ÿ

```typescript
export class CachingStrategy {
  private memoryCache: Map<string, CachedItem> = new Map();
  private redisClient: Redis | null = null;

  constructor() {
    if (process.env.REDIS_URL) {
      this.redisClient = new Redis(process.env.REDIS_URL);
    }
  }

  // è·å–ç¼“å­˜æ•°æ®
  async get<T>(key: string): Promise<T | null> {
    // 1. å…ˆæ£€æŸ¥å†…å­˜ç¼“å­˜
    const memoryItem = this.memoryCache.get(key);
    if (memoryItem && !this.isExpired(memoryItem)) {
      return memoryItem.data as T;
    }

    // 2. æ£€æŸ¥ Redis ç¼“å­˜
    if (this.redisClient) {
      const redisData = await this.redisClient.get(key);
      if (redisData) {
        const parsed = JSON.parse(redisData);

        // å›å¡«å†…å­˜ç¼“å­˜
        this.memoryCache.set(key, {
          data: parsed,
          timestamp: Date.now(),
          ttl: 300000, // 5åˆ†é’Ÿ
        });

        return parsed as T;
      }
    }

    return null;
  }

  // è®¾ç½®ç¼“å­˜æ•°æ®
  async set<T>(key: string, data: T, ttl: number = 300000): Promise<void> {
    const item: CachedItem = {
      data,
      timestamp: Date.now(),
      ttl,
    };

    // è®¾ç½®å†…å­˜ç¼“å­˜
    this.memoryCache.set(key, item);

    // è®¾ç½® Redis ç¼“å­˜
    if (this.redisClient) {
      await this.redisClient.setex(
        key,
        Math.floor(ttl / 1000),
        JSON.stringify(data),
      );
    }
  }

  // æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
  private isExpired(item: CachedItem): boolean {
    return Date.now() - item.timestamp > item.ttl;
  }
}
```

## ğŸ›¡ï¸ å®‰å…¨å’Œåˆè§„æ€§

### ğŸ” 1. æ•°æ®å®‰å…¨

#### æ•æ„Ÿä¿¡æ¯ä¿æŠ¤

```typescript
export class SecurityManager {
  // åŠ å¯†æ•æ„Ÿé…ç½®
  static encryptSensitiveData(data: string): string {
    const algorithm = "aes-256-gcm";
    const secretKey = process.env.ENCRYPTION_KEY || "default-key";

    const cipher = crypto.createCipher(algorithm, secretKey);
    let encrypted = cipher.update(data, "utf8", "hex");
    encrypted += cipher.final("hex");

    return encrypted;
  }

  // è§£å¯†æ•æ„Ÿé…ç½®
  static decryptSensitiveData(encryptedData: string): string {
    const algorithm = "aes-256-gcm";
    const secretKey = process.env.ENCRYPTION_KEY || "default-key";

    const decipher = crypto.createDecipher(algorithm, secretKey);
    let decrypted = decipher.update(encryptedData, "hex", "utf8");
    decrypted += decipher.final("utf8");

    return decrypted;
  }

  // æ¸…ç†æ—¥å¿—ä¸­çš„æ•æ„Ÿä¿¡æ¯
  static sanitizeLogData(data: any): any {
    const sensitiveFields = ["password", "token", "apiKey", "secret"];
    const sanitized = { ...data };

    for (const field of sensitiveFields) {
      if (sanitized[field]) {
        sanitized[field] = "*".repeat(8);
      }
    }

    return sanitized;
  }
}
```

### âš–ï¸ 2. åˆè§„æ€§æªæ–½

#### è¯·æ±‚é¢‘ç‡é™åˆ¶

```typescript
export class RateLimiter {
  private requests: Map<string, number[]> = new Map();
  private limits = {
    perMinute: 10,
    perHour: 100,
    perDay: 1000,
  };

  // æ£€æŸ¥æ˜¯å¦å…è®¸è¯·æ±‚
  async checkRateLimit(identifier: string): Promise<boolean> {
    const now = Date.now();
    const userRequests = this.requests.get(identifier) || [];

    // æ¸…ç†è¿‡æœŸè¯·æ±‚è®°å½•
    const validRequests = userRequests.filter(
      (timestamp) => now - timestamp < 24 * 60 * 60 * 1000, // 24å°æ—¶å†…
    );

    // æ£€æŸ¥å„ç§æ—¶é—´çª—å£çš„é™åˆ¶
    const minuteRequests = validRequests.filter(
      (timestamp) => now - timestamp < 60 * 1000,
    ).length;

    const hourRequests = validRequests.filter(
      (timestamp) => now - timestamp < 60 * 60 * 1000,
    ).length;

    const dayRequests = validRequests.length;

    // æ£€æŸ¥æ˜¯å¦è¶…é™
    if (
      minuteRequests >= this.limits.perMinute ||
      hourRequests >= this.limits.perHour ||
      dayRequests >= this.limits.perDay
    ) {
      return false;
    }

    // è®°å½•æ­¤æ¬¡è¯·æ±‚
    validRequests.push(now);
    this.requests.set(identifier, validRequests);

    return true;
  }
}
```

#### ä½¿ç”¨æ¡æ¬¾éµå®ˆ

```typescript
export class ComplianceChecker {
  // æ£€æŸ¥ robots.txt éµå®ˆæƒ…å†µ
  static async checkRobotsTxt(
    url: string,
    userAgent: string = "*",
  ): Promise<boolean> {
    try {
      const robotsUrl = new URL("/robots.txt", url).href;
      const response = await fetch(robotsUrl);

      if (!response.ok) {
        return true; // å¦‚æœæ²¡æœ‰ robots.txtï¼Œå‡è®¾å…è®¸
      }

      const robotsText = await response.text();
      const rules = this.parseRobotsTxt(robotsText, userAgent);

      return !rules.disallowed.some((pattern) =>
        new RegExp(pattern.replace("*", ".*")).test(url),
      );
    } catch (error) {
      console.warn("æ£€æŸ¥ robots.txt å¤±è´¥:", error);
      return true;
    }
  }

  // è§£æ robots.txt å†…å®¹
  private static parseRobotsTxt(
    content: string,
    userAgent: string,
  ): RobotsRules {
    const lines = content.split("\n");
    const rules: RobotsRules = { disallowed: [], allowed: [] };
    let currentUserAgent = "";

    for (const line of lines) {
      const trimmed = line.trim().toLowerCase();

      if (trimmed.startsWith("user-agent:")) {
        currentUserAgent = trimmed.split(":")[1].trim();
      } else if (currentUserAgent === userAgent || currentUserAgent === "*") {
        if (trimmed.startsWith("disallow:")) {
          const path = trimmed.split(":")[1].trim();
          if (path) rules.disallowed.push(path);
        } else if (trimmed.startsWith("allow:")) {
          const path = trimmed.split(":")[1].trim();
          if (path) rules.allowed.push(path);
        }
      }
    }

    return rules;
  }
}
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡å’Œç›‘æ§

### ğŸ“ˆ 1. å…³é”®æ€§èƒ½æŒ‡æ ‡ (KPIs)

#### ç³»ç»Ÿæ€§èƒ½æŒ‡æ ‡

| æŒ‡æ ‡ç±»åˆ«       | æŒ‡æ ‡åç§°     | ç›®æ ‡å€¼      | å½“å‰å€¼    | çŠ¶æ€    |
| -------------- | ------------ | ----------- | --------- | ------- |
| **ç™»å½•æ€§èƒ½**   | å¹³å‡ç™»å½•æ—¶é—´ | < 30ç§’      | 22ç§’      | âœ… è‰¯å¥½ |
| **ç™»å½•æ€§èƒ½**   | ç™»å½•æˆåŠŸç‡   | > 95%       | 98.2%     | âœ… ä¼˜ç§€ |
| **æœç´¢æ€§èƒ½**   | å•é¡µæœç´¢æ—¶é—´ | < 10ç§’      | 7.5ç§’     | âœ… è‰¯å¥½ |
| **æœç´¢æ€§èƒ½**   | æœç´¢æˆåŠŸç‡   | > 90%       | 94.8%     | âœ… è‰¯å¥½ |
| **æ‰¹é‡å¤„ç†**   | å¹¶å‘å¤„ç†èƒ½åŠ› | 3ä¸ªçº¿ç¨‹     | 3ä¸ªçº¿ç¨‹   | âœ… è¾¾æ ‡ |
| **æ‰¹é‡å¤„ç†**   | æ•°æ®å¤„ç†é€Ÿåº¦ | > 50ä¸ª/å°æ—¶ | 65ä¸ª/å°æ—¶ | âœ… ä¼˜ç§€ |
| **ç³»ç»Ÿç¨³å®šæ€§** | ç³»ç»Ÿå¯ç”¨æ€§   | > 99%       | 99.5%     | âœ… ä¼˜ç§€ |
| **ç³»ç»Ÿç¨³å®šæ€§** | é”™è¯¯ç‡       | < 5%        | 2.1%      | âœ… ä¼˜ç§€ |

#### ä¸šåŠ¡ä»·å€¼æŒ‡æ ‡

| æŒ‡æ ‡ç±»åˆ«     | æŒ‡æ ‡åç§°             | ä»·å€¼                          |
| ------------ | -------------------- | ----------------------------- |
| **æ•ˆç‡æå‡** | æ‰‹åŠ¨æ•°æ®æ”¶é›†æ—¶é—´èŠ‚çœ | æ¯ä¸ªå•†æˆ·èŠ‚çœ 15-20 åˆ†é’Ÿ       |
| **æ•°æ®è´¨é‡** | æ•°æ®å‡†ç¡®æ€§æå‡       | ä» 85% æå‡åˆ° 98%             |
| **è¿è¥æ•ˆç‡** | å¤„ç†è§„æ¨¡æ‰©å¤§         | ä»æ¯æ—¥ 50 ä¸ªå•†æˆ·åˆ° 500 ä¸ªå•†æˆ· |
| **äººåŠ›èµ„æº** | äººåŠ›æˆæœ¬èŠ‚çœ         | å‡å°‘ 2-3 ä¸ª FTE çš„äººå·¥å·¥ä½œé‡  |

### ğŸ“Š 2. ç›‘æ§å’Œå‘Šè­¦ç³»ç»Ÿ

#### å®æ—¶ç›‘æ§é¢æ¿

```typescript
export class MonitoringDashboard {
  private metrics: Map<string, MetricValue[]> = new Map();
  private alerts: Alert[] = [];

  // è®°å½•æŒ‡æ ‡
  recordMetric(
    name: string,
    value: number,
    timestamp: Date = new Date(),
  ): void {
    if (!this.metrics.has(name)) {
      this.metrics.set(name, []);
    }

    const metricArray = this.metrics.get(name)!;
    metricArray.push({ value, timestamp });

    // ä¿æŒæœ€è¿‘1000ä¸ªæ•°æ®ç‚¹
    if (metricArray.length > 1000) {
      metricArray.shift();
    }

    // æ£€æŸ¥å‘Šè­¦æ¡ä»¶
    this.checkAlertConditions(name, value);
  }

  // æ£€æŸ¥å‘Šè­¦æ¡ä»¶
  private checkAlertConditions(metricName: string, value: number): void {
    const thresholds = {
      login_success_rate: { min: 0.95, severity: "high" },
      search_response_time: { max: 10000, severity: "medium" },
      error_rate: { max: 0.05, severity: "high" },
      memory_usage: { max: 500, severity: "medium" },
    };

    const threshold = thresholds[metricName as keyof typeof thresholds];
    if (!threshold) return;

    let alertTriggered = false;
    let alertMessage = "";

    if (threshold.min !== undefined && value < threshold.min) {
      alertTriggered = true;
      alertMessage = `${metricName} ä½äºé˜ˆå€¼: ${value} < ${threshold.min}`;
    }

    if (threshold.max !== undefined && value > threshold.max) {
      alertTriggered = true;
      alertMessage = `${metricName} è¶…è¿‡é˜ˆå€¼: ${value} > ${threshold.max}`;
    }

    if (alertTriggered) {
      this.triggerAlert({
        id: `${metricName}_${Date.now()}`,
        metric: metricName,
        message: alertMessage,
        severity: threshold.severity as "high" | "medium" | "low",
        timestamp: new Date(),
        value,
      });
    }
  }

  // è§¦å‘å‘Šè­¦
  private triggerAlert(alert: Alert): void {
    this.alerts.push(alert);

    // å‘é€å‘Šè­¦é€šçŸ¥
    this.sendAlertNotification(alert);

    // è®°å½•å‘Šè­¦æ—¥å¿—
    this.logger.warn(`å‘Šè­¦è§¦å‘: ${alert.message}`, {
      metric: alert.metric,
      value: alert.value,
      severity: alert.severity,
    });
  }

  // å‘é€å‘Šè­¦é€šçŸ¥
  private async sendAlertNotification(alert: Alert): Promise<void> {
    try {
      // é‚®ä»¶é€šçŸ¥
      if (process.env.ALERT_EMAIL) {
        await this.sendEmailAlert(alert);
      }

      // Slack é€šçŸ¥
      if (process.env.SLACK_WEBHOOK_URL) {
        await this.sendSlackAlert(alert);
      }

      // ä¼ä¸šå¾®ä¿¡é€šçŸ¥
      if (process.env.WECHAT_WEBHOOK_URL) {
        await this.sendWeChatAlert(alert);
      }
    } catch (error) {
      this.logger.error("å‘é€å‘Šè­¦é€šçŸ¥å¤±è´¥:", error);
    }
  }
}
```

## ğŸš€ éƒ¨ç½²å’Œè¿ç»´

### ğŸ³ 1. Docker å®¹å™¨åŒ–éƒ¨ç½²

#### Dockerfile é…ç½®

```dockerfile
# å¤šé˜¶æ®µæ„å»º
FROM node:18-alpine AS builder

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶åŒ…ç®¡ç†æ–‡ä»¶
COPY package*.json pnpm-lock.yaml ./
COPY packages/scraper/package.json ./packages/scraper/

# å®‰è£…ä¾èµ–
RUN npm install -g pnpm
RUN pnpm install --frozen-lockfile

# å¤åˆ¶æºä»£ç 
COPY . .

# æ„å»ºé¡¹ç›®
RUN pnpm build

# ç”Ÿäº§ç¯å¢ƒé•œåƒ
FROM node:18-alpine AS runner

# å®‰è£… Playwright ä¾èµ–
RUN apk add --no-cache \
    chromium \
    nss \
    freetype \
    freetype-dev \
    harfbuzz \
    ca-certificates \
    ttf-freefont

# è®¾ç½® Chromium è·¯å¾„
ENV PUPPETEER_SKIP_CHROMIUM_DOWNLOAD=true
ENV PUPPETEER_EXECUTABLE_PATH=/usr/bin/chromium-browser

# åˆ›å»ºåº”ç”¨ç”¨æˆ·
RUN addgroup -g 1001 -S nodejs
RUN adduser -S scraper -u 1001

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder --chown=scraper:nodejs /app/dist ./dist
COPY --from=builder --chown=scraper:nodejs /app/node_modules ./node_modules
COPY --from=builder --chown=scraper:nodejs /app/package.json ./

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER scraper

# æš´éœ²ç«¯å£
EXPOSE 3000

# å¯åŠ¨å‘½ä»¤
CMD ["node", "dist/index.js"]
```

#### Docker Compose é…ç½®

```yaml
version: "3.8"

services:
  fmtc-scraper:
    build:
      context: .
      dockerfile: Dockerfile
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - DATABASE_URL=postgresql://user:pass@postgres:5432/trendhub
      - REDIS_URL=redis://redis:6379
      - FMTC_USERNAME=${FMTC_USERNAME}
      - FMTC_PASSWORD=${FMTC_PASSWORD}
    depends_on:
      - postgres
      - redis
    volumes:
      - ./logs:/app/logs
      - ./data:/app/data
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: "0.5"
        reservations:
          memory: 512M
          cpus: "0.25"

  postgres:
    image: postgres:14-alpine
    environment:
      - POSTGRES_DB=trendhub
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  postgres_data:
  redis_data:
```

### ğŸ”§ 2. è¿ç»´è„šæœ¬

#### å¥åº·æ£€æŸ¥è„šæœ¬

```bash
#!/bin/bash
# health-check.sh

SERVICE_NAME="fmtc-scraper"
LOG_FILE="/var/log/${SERVICE_NAME}/health-check.log"
WEBHOOK_URL="${SLACK_WEBHOOK_URL}"

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p "$(dirname "$LOG_FILE")"

# è®°å½•æ—¥å¿—å‡½æ•°
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

# æ£€æŸ¥æœåŠ¡çŠ¶æ€
check_service_health() {
    local response
    response=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health)

    if [ "$response" -eq 200 ]; then
        log "âœ… æœåŠ¡å¥åº·æ£€æŸ¥é€šè¿‡"
        return 0
    else
        log "âŒ æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥ (HTTP $response)"
        return 1
    fi
}

# æ£€æŸ¥æ•°æ®åº“è¿æ¥
check_database() {
    local db_status
    db_status=$(docker exec trendhub_postgres_1 pg_isready -U user -d trendhub)

    if echo "$db_status" | grep -q "accepting connections"; then
        log "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
        return 0
    else
        log "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
        return 1
    fi
}

# æ£€æŸ¥å†…å­˜ä½¿ç”¨
check_memory_usage() {
    local memory_usage
    memory_usage=$(docker stats --no-stream --format "{{.MemPerc}}" ${SERVICE_NAME} | sed 's/%//')

    if (( $(echo "$memory_usage < 80" | bc -l) )); then
        log "âœ… å†…å­˜ä½¿ç”¨æ­£å¸¸ (${memory_usage}%)"
        return 0
    else
        log "âš ï¸ å†…å­˜ä½¿ç”¨è¿‡é«˜ (${memory_usage}%)"
        return 1
    fi
}

# å‘é€å‘Šè­¦é€šçŸ¥
send_alert() {
    local message="$1"

    if [ -n "$WEBHOOK_URL" ]; then
        curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸš¨ FMTCçˆ¬è™«å‘Šè­¦: $message\"}" \
            "$WEBHOOK_URL"
    fi
}

# é‡å¯æœåŠ¡
restart_service() {
    log "ğŸ”„ æ­£åœ¨é‡å¯æœåŠ¡..."
    docker-compose restart $SERVICE_NAME

    # ç­‰å¾…æœåŠ¡å¯åŠ¨
    sleep 30

    if check_service_health; then
        log "âœ… æœåŠ¡é‡å¯æˆåŠŸ"
        send_alert "æœåŠ¡å·²è‡ªåŠ¨é‡å¯å¹¶æ¢å¤æ­£å¸¸"
    else
        log "âŒ æœåŠ¡é‡å¯å¤±è´¥"
        send_alert "æœåŠ¡é‡å¯å¤±è´¥ï¼Œéœ€è¦äººå·¥å¹²é¢„"
    fi
}

# ä¸»æ£€æŸ¥æµç¨‹
main() {
    log "å¼€å§‹å¥åº·æ£€æŸ¥..."

    local failed_checks=0

    # æ£€æŸ¥æœåŠ¡å¥åº·
    if ! check_service_health; then
        ((failed_checks++))
    fi

    # æ£€æŸ¥æ•°æ®åº“
    if ! check_database; then
        ((failed_checks++))
    fi

    # æ£€æŸ¥å†…å­˜ä½¿ç”¨
    if ! check_memory_usage; then
        ((failed_checks++))
    fi

    # æ ¹æ®å¤±è´¥æ£€æŸ¥æ•°é‡å†³å®šæ“ä½œ
    if [ $failed_checks -eq 0 ]; then
        log "âœ… æ‰€æœ‰æ£€æŸ¥å‡é€šè¿‡"
    elif [ $failed_checks -le 2 ]; then
        log "âš ï¸ æ£€æµ‹åˆ° $failed_checks é¡¹é—®é¢˜"
        send_alert "æ£€æµ‹åˆ° $failed_checks é¡¹é—®é¢˜ï¼Œè¯·å…³æ³¨"
    else
        log "ğŸš¨ æ£€æµ‹åˆ°ä¸¥é‡é—®é¢˜ï¼Œå‡†å¤‡é‡å¯æœåŠ¡"
        send_alert "æ£€æµ‹åˆ°ä¸¥é‡é—®é¢˜ï¼Œå³å°†è‡ªåŠ¨é‡å¯æœåŠ¡"
        restart_service
    fi

    log "å¥åº·æ£€æŸ¥å®Œæˆ"
}

# æ‰§è¡Œä¸»æµç¨‹
main "$@"
```

#### è‡ªåŠ¨å¤‡ä»½è„šæœ¬

```bash
#!/bin/bash
# backup.sh

BACKUP_DIR="/backup/fmtc-scraper"
DB_NAME="trendhub"
DB_USER="user"
RETENTION_DAYS=30

# åˆ›å»ºå¤‡ä»½ç›®å½•
mkdir -p "$BACKUP_DIR"

# ç”Ÿæˆå¤‡ä»½æ–‡ä»¶å
TIMESTAMP=$(date +%Y%m%d_%H%M%S)
DB_BACKUP_FILE="$BACKUP_DIR/db_backup_$TIMESTAMP.sql"
DATA_BACKUP_FILE="$BACKUP_DIR/data_backup_$TIMESTAMP.tar.gz"

# å¤‡ä»½æ•°æ®åº“
echo "å¼€å§‹å¤‡ä»½æ•°æ®åº“..."
docker exec trendhub_postgres_1 pg_dump -U "$DB_USER" "$DB_NAME" > "$DB_BACKUP_FILE"

if [ $? -eq 0 ]; then
    echo "âœ… æ•°æ®åº“å¤‡ä»½æˆåŠŸ: $DB_BACKUP_FILE"
    gzip "$DB_BACKUP_FILE"
else
    echo "âŒ æ•°æ®åº“å¤‡ä»½å¤±è´¥"
    exit 1
fi

# å¤‡ä»½åº”ç”¨æ•°æ®
echo "å¼€å§‹å¤‡ä»½åº”ç”¨æ•°æ®..."
tar -czf "$DATA_BACKUP_FILE" \
    -C /app/data . \
    --exclude='*.tmp' \
    --exclude='*.log'

if [ $? -eq 0 ]; then
    echo "âœ… åº”ç”¨æ•°æ®å¤‡ä»½æˆåŠŸ: $DATA_BACKUP_FILE"
else
    echo "âŒ åº”ç”¨æ•°æ®å¤‡ä»½å¤±è´¥"
fi

# æ¸…ç†æ—§å¤‡ä»½
echo "æ¸…ç†è¶…è¿‡ $RETENTION_DAYS å¤©çš„æ—§å¤‡ä»½..."
find "$BACKUP_DIR" -name "*.gz" -mtime +$RETENTION_DAYS -delete
find "$BACKUP_DIR" -name "*.tar.gz" -mtime +$RETENTION_DAYS -delete

echo "å¤‡ä»½å®Œæˆ"
```

## ğŸ”® æœªæ¥å‘å±•è§„åˆ’

### ğŸ“… çŸ­æœŸè®¡åˆ’ (1-3ä¸ªæœˆ)

#### 1. åŠŸèƒ½å¢å¼º

- **æ™ºèƒ½é‡è¯•æœºåˆ¶**: åŸºäºå¤±è´¥åŸå› çš„æ™ºèƒ½é‡è¯•ç­–ç•¥
- **æ•°æ®å»é‡ä¼˜åŒ–**: æ›´é«˜æ•ˆçš„å•†æˆ·æ•°æ®å»é‡ç®—æ³•
- **å¤šè¯­è¨€æ”¯æŒ**: æ”¯æŒè‹±è¯­ã€ä¸­æ–‡ã€æ—¥è¯­ç­‰å¤šè¯­è¨€ç•Œé¢
- **ç§»åŠ¨ç«¯é€‚é…**: å“åº”å¼è®¾è®¡ä¼˜åŒ–ï¼Œæ”¯æŒç§»åŠ¨è®¾å¤‡ç®¡ç†

#### 2. æ€§èƒ½ä¼˜åŒ–

- **å¹¶å‘èƒ½åŠ›æå‡**: ä»3ä¸ªå¹¶å‘æå‡åˆ°5-8ä¸ªå¹¶å‘
- **å†…å­˜ä¼˜åŒ–**: å‡å°‘50%çš„å†…å­˜å ç”¨
- **æ•°æ®åº“ä¼˜åŒ–**: æŸ¥è¯¢å“åº”æ—¶é—´æå‡30%
- **ç¼“å­˜ç­–ç•¥**: å®ç°åˆ†å¸ƒå¼ç¼“å­˜ç³»ç»Ÿ

### ğŸš€ ä¸­æœŸè®¡åˆ’ (3-6ä¸ªæœˆ)

#### 1. æ™ºèƒ½åŒ–å‡çº§

- **AI æ•°æ®éªŒè¯**: ä½¿ç”¨æœºå™¨å­¦ä¹ éªŒè¯æ•°æ®å‡†ç¡®æ€§
- **æ™ºèƒ½åˆ†ç±»**: è‡ªåŠ¨è¯†åˆ«å’Œåˆ†ç±»å•†æˆ·ç±»å‹
- **å¼‚å¸¸æ£€æµ‹**: è‡ªåŠ¨è¯†åˆ«å¼‚å¸¸æ•°æ®å’Œè¡Œä¸ºæ¨¡å¼
- **é¢„æµ‹æ€§ç»´æŠ¤**: åŸºäºå†å²æ•°æ®é¢„æµ‹ç³»ç»Ÿé—®é¢˜

#### 2. æ‰©å±•æ€§å¢å¼º

- **å¤šç«™ç‚¹æ”¯æŒ**: æ”¯æŒæ›´å¤šä»£ç†ç½‘ç»œå¹³å°
- **API å¼€æ”¾**: æä¾›ç¬¬ä¸‰æ–¹é›†æˆ API
- **æ’ä»¶ç³»ç»Ÿ**: æ”¯æŒè‡ªå®šä¹‰æ•°æ®å¤„ç†æ’ä»¶
- **å¾®æœåŠ¡æ¶æ„**: æ‹†åˆ†ä¸ºç‹¬ç«‹çš„å¾®æœåŠ¡

### ğŸŒŸ é•¿æœŸæ„¿æ™¯ (6-12ä¸ªæœˆ)

#### 1. ç”Ÿæ€ç³»ç»Ÿå»ºè®¾

- **æ•°æ®ä¸­å¿ƒ**: å»ºç«‹ç»Ÿä¸€çš„å•†æˆ·æ•°æ®ä¸­å¿ƒ
- **BI ç³»ç»Ÿ**: å®Œæ•´çš„å•†ä¸šæ™ºèƒ½å’ŒæŠ¥è¡¨ç³»ç»Ÿ
- **å¼€æ”¾å¹³å°**: é¢å‘åˆä½œä¼™ä¼´çš„å¼€æ”¾å¹³å°
- **ç¤¾åŒºå»ºè®¾**: å¼€å‘è€…ç¤¾åŒºå’Œæ–‡æ¡£ç”Ÿæ€

#### 2. æŠ€æœ¯åˆ›æ–°

- **è¾¹ç¼˜è®¡ç®—**: éƒ¨ç½²è¾¹ç¼˜èŠ‚ç‚¹æå‡å…¨çƒè®¿é—®é€Ÿåº¦
- **åŒºå—é“¾é›†æˆ**: æ•°æ®æº¯æºå’Œå®Œæ•´æ€§éªŒè¯
- **å®æ—¶æ•°æ®æµ**: åŸºäº Kafka çš„å®æ—¶æ•°æ®å¤„ç†
- **å®¹å™¨ç¼–æ’**: Kubernetes è‡ªåŠ¨åŒ–éƒ¨ç½²å’Œç®¡ç†

## ğŸ“š æ€»ç»“ä¸åæ€

### ğŸ¯ é¡¹ç›®æˆå°±

#### æŠ€æœ¯æˆå°±

1. **åˆ›æ–°æ¶æ„**: æˆåŠŸå®ç°äº†åŒçˆ¬è™«æ¶æ„ï¼Œå…¼é¡¾äº†çµæ´»æ€§å’Œæ€§èƒ½
2. **åæ£€æµ‹æŠ€æœ¯**: å¼€å‘äº†å…ˆè¿›çš„åæ£€æµ‹æœºåˆ¶ï¼Œæ˜¾è‘—æé«˜æŠ“å–æˆåŠŸç‡
3. **å®æ—¶ç›‘æ§**: å®ç°äº†åŸºäº SSE çš„å®æ—¶è¿›åº¦ç›‘æ§ç³»ç»Ÿ
4. **æ•°æ®è´¨é‡**: å»ºç«‹äº†å®Œå–„çš„æ•°æ®éªŒè¯å’Œæ¸…æ´—æµç¨‹

#### ä¸šåŠ¡ä»·å€¼

1. **æ•ˆç‡æå‡**: å°†å•†æˆ·æ•°æ®æ”¶é›†æ•ˆç‡æå‡äº†10å€ä»¥ä¸Š
2. **æˆæœ¬èŠ‚çº¦**: èŠ‚çœäº†å¤§é‡äººå·¥æˆæœ¬å’Œæ—¶é—´æŠ•å…¥
3. **æ•°æ®è´¨é‡**: æ•°æ®å‡†ç¡®æ€§ä»85%æå‡åˆ°98%
4. **æ‰©å±•èƒ½åŠ›**: æ”¯æ’‘äº†ä¸šåŠ¡è§„æ¨¡çš„å¿«é€Ÿå¢é•¿

### ğŸ¤” ç»éªŒæ•™è®­

#### æŠ€æœ¯æ•™è®­

1. **æ—©æœŸæ¶æ„è§„åˆ’çš„é‡è¦æ€§**: è‰¯å¥½çš„æ¶æ„è®¾è®¡ä¸ºåç»­æ‰©å±•å¥ å®šäº†åŸºç¡€
2. **æ¸è¿›å¼ä¼˜åŒ–ç­–ç•¥**: é€šè¿‡æŒç»­çš„æ€§èƒ½ç›‘æ§å’Œä¼˜åŒ–ï¼Œç³»ç»Ÿæ€§èƒ½å¾—åˆ°æ˜¾è‘—æå‡
3. **å®¹é”™è®¾è®¡çš„å¿…è¦æ€§**: å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶ä¿è¯äº†ç³»ç»Ÿçš„ç¨³å®šæ€§
4. **æ–‡æ¡£å’Œæµ‹è¯•çš„ä»·å€¼**: è¯¦ç»†çš„æ–‡æ¡£å’Œæµ‹è¯•ç”¨ä¾‹å¤§å¤§é™ä½äº†ç»´æŠ¤æˆæœ¬

#### ç®¡ç†ç»éªŒ

1. **ç”¨æˆ·åé¦ˆé©±åŠ¨**: æŒç»­æ”¶é›†ç”¨æˆ·åé¦ˆï¼Œå¿«é€Ÿè¿­ä»£æ”¹è¿›
2. **è·¨å›¢é˜Ÿåä½œ**: å‰ç«¯ã€åç«¯ã€è¿ç»´å›¢é˜Ÿçš„ç´§å¯†åä½œæ˜¯æˆåŠŸçš„å…³é”®
3. **é£é™©ç®¡æ§**: å»ºç«‹äº†å®Œå–„çš„ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶ï¼ŒåŠæ—¶å‘ç°å’Œå¤„ç†é—®é¢˜
4. **çŸ¥è¯†ä¼ æ‰¿**: é€šè¿‡æ–‡æ¡£å’ŒåŸ¹è®­ï¼Œç¡®ä¿çŸ¥è¯†åœ¨å›¢é˜Ÿå†…éƒ¨ä¼ æ‰¿

### ğŸ† æœ€ä½³å®è·µæ€»ç»“

#### å¼€å‘å®è·µ

1. **ä»£ç è´¨é‡**: ä¸¥æ ¼çš„ä»£ç å®¡æŸ¥å’Œæµ‹è¯•è¦†ç›–ç‡è¦æ±‚
2. **ç‰ˆæœ¬æ§åˆ¶**: è§„èŒƒçš„ Git å·¥ä½œæµå’Œç‰ˆæœ¬å‘å¸ƒæµç¨‹
3. **æŒç»­é›†æˆ**: è‡ªåŠ¨åŒ–çš„æ„å»ºã€æµ‹è¯•å’Œéƒ¨ç½²æµç¨‹
4. **æ€§èƒ½ç›‘æ§**: å…¨é¢çš„æ€§èƒ½ç›‘æ§å’Œå‘Šè­¦æœºåˆ¶

#### è¿ç»´å®è·µ

1. **å®¹å™¨åŒ–éƒ¨ç½²**: ä½¿ç”¨ Docker å®ç°æ ‡å‡†åŒ–éƒ¨ç½²
2. **è‡ªåŠ¨åŒ–è¿ç»´**: é€šè¿‡è„šæœ¬è‡ªåŠ¨åŒ–æ—¥å¸¸è¿ç»´ä»»åŠ¡
3. **å¤‡ä»½ç­–ç•¥**: å®Œå–„çš„æ•°æ®å¤‡ä»½å’Œæ¢å¤æœºåˆ¶
4. **å®‰å…¨é˜²æŠ¤**: å¤šå±‚æ¬¡çš„å®‰å…¨é˜²æŠ¤æªæ–½

---

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰æŠ€æœ¯é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·é€šè¿‡ä»¥ä¸‹æ–¹å¼è”ç³»ï¼š

- **é¡¹ç›®æ–‡æ¡£**: [FMTCå¼€å‘æŒ‡å—](./fmtc-development-guide.md)
- **APIæ–‡æ¡£**: [FMTC APIå‚è€ƒ](./fmtc-api-reference.md)
- **æ¶æ„æ–‡æ¡£**: [FMTCæ¶æ„æ·±åº¦åˆ†æ](./fmtc-architecture-deep-dive.md)
- **é—®é¢˜åé¦ˆ**: GitHub Issues
- **æŠ€æœ¯è®¨è®º**: é¡¹ç›®å†…éƒ¨æŠ€æœ¯ç¾¤

---

_æœ¬æ–‡æ¡£æœ€åæ›´æ–°: 2024å¹´2æœˆ_
_æ–‡æ¡£ç‰ˆæœ¬: v1.0.0_
_ç»´æŠ¤å›¢é˜Ÿ: TrendHub æŠ€æœ¯å›¢é˜Ÿ_
