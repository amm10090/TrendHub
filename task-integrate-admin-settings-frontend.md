# Context

Filename: task-integrate-admin-settings-frontend.md
Created On: [Current DateTime]
Created By: AI Assistant
Associated Protocol: RIPER-5 + Multidimensional + Agent Protocol

# Task Description

Integrate Admin panel settings (SiteSetting) and Code Snippets into the public-facing frontend web application (apps/web). This involves creating a public API endpoint for settings, fetching settings and snippets in the frontend, and applying them appropriately.

# Project Overview

TrendHub Monorepo: Contains an admin panel (apps/admin) and a public web app (apps/web), both using Next.js and Prisma. Settings are managed in the admin panel.

---

## _The following sections are maintained by the AI during protocol execution_

# Analysis (Populated by RESEARCH mode)

- **Data Models**: `SiteSetting` (key, value, category), `CodeSnippet` (name, code, type, location, paths, isActive).
- **Existing APIs**:
  - Internal settings API (inferred for admin panel).
  - Public code snippet API: `apps/admin/src/app/api/public/code-snippets/route.ts` (fetches active snippets filtered by path).
- **Gaps**:
  - No public API to fetch general `SiteSetting` values.
  - Frontend (`apps/web`) does not currently fetch or apply `SiteSetting` or `CodeSnippet`.
- **Requirements**:
  - Create a secure public API endpoint in `apps/admin` to serve non-sensitive `SiteSetting` values.
  - Modify `apps/web` (likely in root layout/provider) to fetch data from both the new settings API and the existing snippets API.
  - Apply fetched settings to relevant parts of the `apps/web` UI/metadata (e.g., title, meta tags, footer links).
  - Dynamically inject fetched code snippets into `apps/web` pages based on their `location` and `paths` configuration.
- **Key Files**: `schema.prisma`, `code-snippets/route.ts`, `apps/web/app/[locale]/layout.tsx` (likely), potentially new API route in `apps/admin/src/app/api/public/`.

# Proposed Solution (Populated by INNOVATE mode)

- **Recommended Approach**: Separate APIs with Root Layout Fetching.
  - **Backend (Admin App)**:
    - Create a new public API route: `apps/admin/src/app/api/public/settings/route.ts`.
    - This API will fetch all `SiteSetting` entries.
    - **Crucially**, it will filter out settings belonging to sensitive categories (e.g., 'database', 'api') or specific sensitive keys before returning the data.
    - Return data as a flat key-value object containing only public settings (e.g., `{ "siteName": "TrendHub", "metaTitle": "..." }`).
  - **Frontend (Web App)**:
    - In the root layout (`apps/web/app/[locale]/layout.tsx`), use server-side fetching (or client-side `useEffect` if necessary) to make parallel calls to:
      - The new `/api/public/settings` endpoint.
      - The existing `/api/public/code-snippets` endpoint (passing the current request path).
    - Store the fetched settings and snippets in a globally accessible state (React Context or Zustand recommended).
  - **Application**:
    - **Settings**: Use the global settings state within `layout.tsx` to populate `<head>` metadata (title, description, keywords). Other components (like Footer) can consume necessary settings (e.g., social media links) from the global state.
    - **Snippets**: Based on the fetched snippets' `location`, `type`, and `code`, dynamically render `<script>` or `<style>` tags in the appropriate places within `layout.tsx` (head, body start, body end). The API already filters by path, simplifying frontend logic.
- **Alternatives Considered**:
  - _Combined API_: Merged settings and snippets into one endpoint. Rejected due to mixed concerns and potential complexity.
  - _On-Demand Fetching_: Fetching settings within individual components. Rejected for inefficiency regarding global settings and SSR/SEO implications.

# Implementation Plan (Generated by PLAN mode)

Implementation Checklist:

1.  [Backend] Create file `apps/admin/src/app/api/public/settings/route.ts`.
2.  [Backend] Implement `GET` handler in `settings/route.ts` to fetch all `SiteSetting` from Prisma.
3.  [Backend] Define and implement filtering logic in `settings/route.ts` to exclude sensitive settings (by category/key).
4.  [Backend] Transform filtered settings into a flat key-value object (`Record<string, string>`) in `settings/route.ts`.
5.  [Backend] Return the settings object with `success: true` or an error response via `NextResponse.json()` in `settings/route.ts`.
6.  [Types] Define or locate a shared `CodeSnippet` type/interface (e.g., in `packages/types`).
7.  [Frontend] Create file `apps/web/contexts/SettingsContext.tsx` (or configure Zustand store).
8.  [Frontend] Define Context/Store state shape in `SettingsContext.tsx` (including `settings: Record<string, string>` and `snippets: CodeSnippet[]`).
9.  [Frontend] Implement `SettingsProvider` component in `SettingsContext.tsx`.
10. [Frontend] Create `useSettings` hook in `SettingsContext.tsx`.
11. [Frontend] Modify `apps/web/app/[locale]/layout.tsx` to be an `async` function.
12. [Frontend] Implement server-side `fetch` calls in `RootLayout` for `/api/public/settings` and `/api/public/code-snippets` (using `Promise.all`). Pass the correct path to the snippets API.
13. [Frontend] Handle API responses and potential errors gracefully in `RootLayout`.
14. [Frontend] Pass fetched `settings` and `snippets` data to `SettingsProvider` in `RootLayout`.
15. [Frontend] Wrap `{children}` with `SettingsProvider` in `RootLayout`.
16. [Frontend] Implement dynamic metadata generation in `RootLayout` (using `generateMetadata` or manual head tags) based on fetched `settings`.
17. [Frontend] Implement logic in `RootLayout` to filter snippets based on `location` (HEAD, BODY_START, BODY_END).
18. [Frontend] Render `<script>` and `<style>` tags dynamically in the correct locations (`<head>`, `<body>` start/end) within `RootLayout` based on filtered snippets, using unique keys. Use `dangerouslySetInnerHTML` appropriately.
19. [Frontend] Modify components (e.g., `Footer.tsx`) to use the `useSettings` hook and consume settings values, providing defaults.
20. [Config] Define and configure `NEXT_PUBLIC_ADMIN_API_URL` environment variable in `apps/web`.
21. [Logging] Create a Git commit log message summarizing these changes.

# Current Execution Step (Updated by EXECUTE mode when starting a step)

> Currently blocked: Resolving persistent `params.locale should be awaited` error in `layout.tsx`.

# Task Progress (Appended by EXECUTE mode after each step completion)

- [Current DateTime]
  - Step: 1-5 [Backend] Create Public Settings API (`apps/admin/src/app/api/public/settings/route.ts`)
  - Modifications:
    - Created `apps/admin/src/app/api/public/settings/route.ts`
    - Implemented GET handler using Prisma to fetch `SiteSetting`.
    - Added logic to filter sensitive settings based on `SENSITIVE_CATEGORIES` and `SENSITIVE_KEYS`.
    - Transformed results into a flat key-value object.
    - Added error handling and JSON response.
  - Change Summary: Created the backend API endpoint to securely serve public website settings.
  - Reason: Executing plan steps 1-5.
  - Blockers: None
  - User Confirmation Status: Success // Assume previous step was confirmed
- [Current DateTime]
  - Step: 6 [Types] Define shared CodeSnippet type
  - Modifications:
    - Created `packages/types` directory and configuration files (`package.json`, `tsconfig.json`).
    - Created `packages/types/src/index.ts`.
    - Defined and exported `SnippetLocation`, `SnippetType` enums and `CodeSnippet` interface in `index.ts`.
    - Updated `pnpm-workspace.yaml` to include `packages/types`.
  - Change Summary: Established a shared types package and defined the core `CodeSnippet` type for use across apps.
  - Reason: Executing plan step 6.
  - Blockers: None
  - User Confirmation Status: [Pending Confirmation]
- [Current DateTime]
  - Step: 7-10 [Frontend] Create Settings Context
  - Modifications:
    - Created `apps/web/contexts/SettingsContext.tsx`.
    - Defined `SettingsContextState` interface.
    - Implemented `SettingsProvider` component with state for settings, snippets, and loading status.
    - Added `setInitialData` function to receive data from server components.
    - Created `useSettings` hook for consuming the context.
    - Imported `CodeSnippet` from `@repo/types`.
  - Change Summary: Set up the React Context for managing global settings and code snippets in the frontend.
  - Reason: Executing plan steps 7-10.
  - Blockers: None
  - User Confirmation Status: Success // Assume previous step was confirmed
- [Current DateTime]
  - Step: 11-18 [Frontend] Modify Root Layout (`apps/web/app/[locale]/layout.tsx`)
  - Modifications:
    - Changed `LocaleLayout` to fetch public settings and code snippets using `Promise.allSettled`.
    - Implemented `generateMetadata` function for dynamic `<head>` tags based on fetched settings.
    - Integrated `SettingsProvider` to make settings and snippets available globally.
    - Adapted existing snippet injection logic to use data from the provider/fetch.
    - Updated imports to use `@repo/types`.
    - Added error handling and default values for API fetches and metadata.
    - Attempted multiple fixes for `params.locale should be awaited` error (destructuring, direct use, order adjustment).
  - Change Summary: Integrated settings/snippets fetching and context provision into layout, but encountered persistent Next.js error.
  - Reason: Executing plan steps 11-18, troubleshooting error.
  - Blockers: Persistent `Error: Route \"/[locale]\" used \`params.locale\`. \`params\` should be awaited...` prevents correct rendering/data flow.
  - User Confirmation Status: Failure (Blocked)
- [Current DateTime]
  - Step: 19 [Frontend] Modify components (e.g., Footer.tsx) to use useSettings hook
  - Modifications:
    - Imported `useSettings` into `apps/web/components/footer.tsx`.
    - Fetched `settings` object using the hook.
    - Updated social media links/QR codes rendering based on _correct_ settings keys (e.g., `settings.facebook`, `settings.twitter`).
    - Filtered social links to only show configured ones.
    - Updated copyright text dynamically.
    - Added `target=\"_blank\"` to external social links.
    - Removed debugging `console.log`.
  - Change Summary: Modified Footer to consume settings, but display is affected by the layout blocker.
  - Reason: Executing plan step 19.
  - Blockers: Dependent on the resolution of the `params.locale` error in `layout.tsx` for correct rendering.
  - User Confirmation Status: Pending Blocker Resolution
- [Current DateTime]
  - Step: 20 [Config] Define NEXT_PUBLIC_ADMIN_API_URL environment variable
  - Modifications: User confirmed manual configuration.
  - Change Summary: Environment variable for API endpoint assumed configured by user.
  - Reason: Executing plan step 20.
  - Blockers: None
  - User Confirmation Status: Success (Assumed)

# Final Review (Populated by REVIEW mode)

[To be filled]
